<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.302">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kevin Hannay">

<title>Malware Detection from Network Captures</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="report_files/libs/clipboard/clipboard.min.js"></script>
<script src="report_files/libs/quarto-html/quarto.js"></script>
<script src="report_files/libs/quarto-html/popper.min.js"></script>
<script src="report_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="report_files/libs/quarto-html/anchor.min.js"></script>
<link href="report_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="report_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="report_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="report_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="report_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#assumptions" id="toc-assumptions" class="nav-link" data-scroll-target="#assumptions"><span class="header-section-number">2</span> Assumptions</a></li>
  <li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering"><span class="header-section-number">3</span> Feature Engineering</a></li>
  <li><a href="#model-selection" id="toc-model-selection" class="nav-link" data-scroll-target="#model-selection"><span class="header-section-number">4</span> Model Selection</a></li>
  <li><a href="#ml-ops-pipeline" id="toc-ml-ops-pipeline" class="nav-link" data-scroll-target="#ml-ops-pipeline"><span class="header-section-number">5</span> ML Ops Pipeline</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions"><span class="header-section-number">6</span> Conclusions</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">7</span> References</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Malware Detection from Network Captures</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Kevin Hannay </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>This report summrarizes the work done in creating a classification model for malware detection from network captures (PCAP) files. The project is organized into a set of jupyter notebooks located in the <code>nbs</code> directory, with the majority of the logic located in the <code>00_core.ipynb</code> notebook. Additionally, using the nbdev library, the code in the notebooks is exported to a python package located in the <code>mdetect</code> directory.</p>
<p>From the home directory of the project the python package can be installed using the following command:</p>
<pre class="{bash}"><code>#| eval: false 
pip install -e .</code></pre>
<p>The python package also defines three command line scripts which can be used to run the project from the command line. These scripts are defined in the <code>01_cli.ipynb</code> notebook and are as follows:</p>
<p>These allow for the project to move through the ML Ops pipeline from the command line, and also provide some wrapper code for getting started quickly with the models.</p>
</section>
<section id="assumptions" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="assumptions"><span class="header-section-number">2</span> Assumptions</h2>
<p>For the purposes of this project I made the following assumptions about the customer need:</p>
<ul>
<li>This model would be deployed on networks that aren’t in the training data, i.e.&nbsp;we don’t have pcap files which can be used to build a baseline for benign traffic for the specific network. If this data is available then it could be used to improve the model performance.</li>
<li>The pcap data is being batch processed so that these files are periodically analyzed for malware signature, rather than a streaming solution.</li>
</ul>
</section>
<section id="feature-engineering" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="feature-engineering"><span class="header-section-number">3</span> Feature Engineering</h2>
<p>The first step in the project is to transform the raw PCAP data into a set of features which can be used for classification. For this I made use of the scapy python library and created some wrappers and data structures to process and store the data in the raw PCAP files. My strategy for processing the PCAP files was to focus on TCP/UDP traffic and seperate the files into seperate flows or sessions. These flows are defined by unique 5-tuples of (src_ip, dst_ip, src_port, dst_port, protocol), and then these flows were further broken down along the time dimension by splitting up packets within a flow which were seperated in time. The logic behind this step was the need for this model to generalize to new PCAP files which may have more or less benign traffic overlayed on the malicious traffic. The conversion from PCAP to flows should help reduce the impact of benign traffic on the model.</p>
<p>The next step was to compute features on these flows</p>
<p>My overall technique focused on extracting features which should generalize well when applied to new network captures. Therefore, I tried to avoid using features that might be specific to the particular network used in the capture. For example, while I developed some features based on the Inner Arrival times of the packets I avoided using these features in the final model as they would be specific to the network used in the capture. However, in the event that we have access to data collected on a single network, these features could be used to improve the model.</p>
<p>In the end I ended up constructing a set of 20 features which I used in the final model. These features are as follows:</p>
<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Markdown</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>feature_names <span class="op">=</span> [<span class="st">'duration'</span>, <span class="st">'pkts_rate'</span>, <span class="st">'bytes_rate'</span>, <span class="st">'mean_size'</span>, <span class="st">'std_sizes'</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>       <span class="st">'q1_sizes'</span>, <span class="st">'q2_sizes'</span>, <span class="st">'q3_sizes'</span>, <span class="st">'min_sizes'</span>, <span class="st">'max_sizes'</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>       <span class="st">'num_pkts'</span>, <span class="st">'num_bytes'</span>, <span class="st">'src_port'</span>, <span class="st">'dst_port'</span>, <span class="st">'protocol'</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>       <span class="st">'flags_FIN'</span>, <span class="st">'flags_SYN'</span>, <span class="st">'flags_RST'</span>, <span class="st">'flags_PSH'</span>, <span class="st">'flags_ACK'</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>       <span class="st">'flags_URG'</span>, <span class="st">'flags_ECE'</span>, <span class="st">'flags_CWR'</span>]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>feature_type <span class="op">=</span> [<span class="st">'numeric'</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">12</span>)] <span class="op">+</span> [<span class="st">'categorical'</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>)] <span class="op">+</span> [<span class="st">'numeric'</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">8</span>)]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>descriptions <span class="op">=</span> [<span class="st">""</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(feature_names))]</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>feature_table <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(feature_names, feature_type, descriptions))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>Markdown(tabulate(</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  feature_table, </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  headers<span class="op">=</span>[<span class="st">"Name"</span>,<span class="st">"Type"</span>, <span class="st">"Description"</span>]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<div id="tbl-features" class="anchored">
<table class="table table-sm table-striped small">
<caption>Table&nbsp;1: The features used in the classification algorithms</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">duration</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">pkts_rate</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">bytes_rate</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">mean_size</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">std_sizes</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">q1_sizes</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">q2_sizes</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">q3_sizes</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">min_sizes</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">max_sizes</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">num_pkts</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">num_bytes</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">src_port</td>
<td style="text-align: left;">categorical</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">dst_port</td>
<td style="text-align: left;">categorical</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">protocol</td>
<td style="text-align: left;">categorical</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">flags_FIN</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">flags_SYN</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">flags_RST</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">flags_PSH</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">flags_ACK</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">flags_URG</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">flags_ECE</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">flags_CWR</td>
<td style="text-align: left;">numeric</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<ul>
<li>‘duration’</li>
<li>‘pkts_rate’</li>
<li>‘bytes_rate’,</li>
<li>‘mean_size’,</li>
<li>‘std_sizes’,</li>
<li>‘q1_sizes’,</li>
<li>‘q2_sizes’,</li>
<li>‘q3_sizes’,</li>
<li>‘min_sizes’,</li>
<li>‘max_sizes’,</li>
<li>‘num_pkts’,</li>
<li>‘num_bytes’,</li>
<li>‘src_port’,</li>
<li>‘dst_port’,</li>
<li>‘protocol’,</li>
<li>‘flags_FIN’,</li>
<li>‘flags_SYN’,</li>
<li>‘flags_RST’,</li>
<li>‘flags_PSH’,</li>
<li>‘flags_ACK’,</li>
<li>‘flags_URG’,</li>
<li>‘flags_ECE’,</li>
<li>‘flags_CWR’</li>
</ul>
<p>The PCAP files were processed into a set of these flows where each flow was labeled as being from a malicious capture (1) or a benign capture. I supplemented the benign PCAP files with two additional PCAP files since the benign data set provided has significantly fewer flows that the aggregate of the malware samples.</p>
<p>The data was divided into a training and validation set randomly.</p>
</section>
<section id="model-selection" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="model-selection"><span class="header-section-number">4</span> Model Selection</h2>
<p>I tested a set of (6-8) Machine learning pipelines on this processed data set, as can be seen in the <code>00_core.ipynb</code>. The principal metric I used in comparing models was the (AUC: Area under the Curve) based on ROC Curves for the models. I also performed a five-fold cross-validation of the model performances overall accuracy on the training data.</p>
</section>
<section id="ml-ops-pipeline" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="ml-ops-pipeline"><span class="header-section-number">5</span> ML Ops Pipeline</h2>
<p>Design a pipeline for your model in Elastic. The pipeline should include the technologies that you will use, whether this is Elastic or others, for the following: - Feature registry, - Model registry, - Model Deployment, - - Testing.</p>
<p>The logical building blocks for the training, deployment and testing of a malware prediction model can be broken down into some logical flows:</p>
<ol type="1">
<li>Raw data storage. This involves the storage of the raw PCAP data as provided as the training data in this project along with partitions of the PCAP data</li>
<li>Feature engineering. This involves the tranformation of the raw PCAP data into the features which will be fed into the ML algorithm used in the classification. Specifically, for my work this involves the transformation of PCAP data into flows and the computation of the summary statistics on those flows. These feature transformations should then be saved for either use in prediction or training. To ensure the reproducibility of these computations the transformation component of the pipeline should be versioned and this information stored alongside the values.</li>
<li>In model training this features can then be fed into a ML model for classification and these predictions compared against the known labels. Various metrics should be computed to evaluate model performance including the (overall accuracy, confusion matrix, AUC/ROC curves, F1 score, etc) and those values should be stored for comparison alongside the (data version and model version).</li>
<li>For models which are deployed for inference the model metrics</li>
<li></li>
</ol>
</section>
<section id="conclusions" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="conclusions"><span class="header-section-number">6</span> Conclusions</h2>
</section>
<section id="references" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="references"><span class="header-section-number">7</span> References</h2>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>